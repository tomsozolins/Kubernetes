K3S installation
------------
Prepare OS
# vi /etc/hostname
# vi /etc/hosts
# vi /etc/chrony.conf
pool <ntp-server-address> iburst prefer
# systemctl restart chronyd

# vi ~/.ssh/authorized_keys
Remove this line, if exists:
no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command="echo 'Please login as the user \"ubuntu\" rather than the user \"root\".';echo;sleep 10"
----------------------------
On first master node:
# curl -sLS https://get.k3sup.dev | sh

Add private ssh key to ~/.ssh/id_rsa
# vi ~/.ssh/id_rsa
# chmod 400 ~/.ssh/id_rsa

# k3sup install --cluster --user=root --ip <node-ip-address> --tls-san <VIP-address> --k3s-extra-args="--disable servicelb"
-------------------
Kube-vip installation
# export VIP=x.x.x.x
# export INTERFACE=ethx

# curl -s https://kube-vip.io/manifests/rbac.yaml > /var/lib/rancher/k3s/server/manifests/kube-vip-rbac.yaml
# curl -sL kube-vip.io/k3s | vipAddress=$VIP vipInterface=$INTERFACE sh | sudo tee /var/lib/rancher/k3s/server/manifests/kube-vip.yaml
# vi /etc/rancher/k3s/k3s.yaml
- cluster:
     server: <VIP-address>
-------------------------
Add master nodes:
# k3sup join --ip=<node-ip-address> --server-ip=<VIP-address> --user=root --server-user=root --server --k3s-extra-args="--disable servicelb"

Add worker nodes:
# k3sup join --ip=<node-ip-address> --server-ip=<VIP-address> --user=root --server-user=root

-------------------------------

Check status:
# kubectl get all --all-namespaces
# kubectl get nodes -o wide
# kubectl get endpoints -n kube-system
# kubectl get service -n kube-system
# kubectl get endpoints kube-controller-manager --namespace=kube-system -o yaml

-------------------------------
Uninstall K3S

Server:
# /usr/local/bin/k3s-uninstall.sh

Agent:
# /usr/local/bin/k3s-agent-uninstall.sh

---------------
MetalLB:
# helm repo add metallb https://metallb.github.io/metallb
# export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

# vi values.yaml
configInline:
  address-pools:
   - name: default
     protocol: layer2
     addresses:
     - <X.X.X.X-X.X.X.X>
     
# helm install metallb metallb/metallb -f values.yaml
---------------
OLD:
Kube-vip Cloud Provider installation
https://kube-vip.io/usage/on-prem/

# kubectl apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml
# kubectl delete configmap --namespace kube-system kubevip
# kubectl create configmap --namespace kube-system kubevip --from-literal range-global=X.X.X.X-X.X.X.X
# kubectl describe pods -n kube-system kube-vip-cloud-provider-0
# kubectl logs -n kube-system kube-vip-cloud-provider-0 -f
# kubectl get configmap kubevip -o json -n kube-system
